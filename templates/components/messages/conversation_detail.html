{% extends "base.html" %}
{% load static %}

{% block title %}Grupos{% endblock %}

{% block navbar %}
{% include 'components/navbar.html' %}
{% endblock navbar %}

{% block left_sidebar %}
{% include 'components/sidebars/left/sidebar.html' %}
{% endblock left_sidebar %}

{% block right_sidebar %}
{% include 'components/sidebars/right/sidebar.html' %}
{% endblock right_sidebar %}

{% block content %}
<div class="h-[calc(100vh-4rem)] flex bg-gray-100 dark:bg-dark-main">

        <!-- sidebar chat -->
    <aside class="w-80 bg-white dark:bg-dark-second border-r dark:border-dark-third overflow-y-auto">
<div>
        <h2 class="p-4 font-bold text-lg dark:text-dark-txt">
            ðŸ’¬ Chats
        </h2>
        <a href="{% url 'messaging:archived_inbox' %}"
        class="text-sm text-gray-500 hover">
        ðŸ“¦ Archivados
        </a>
    </div>
    
{% for conv in sidebar_conversations %}
<div class="relative border-b">

    <!-- MENU (NO EMPUJA NADA) -->
    <div class="absolute top-2 right-2 z-10">
        {% include "components/menus/conversation_menu.html" with conversation=conv %}
    </div>

    <!-- CARD CLICKABLE -->
    <a href="{% url 'messaging:conversation_detail' conv.id %}"
       class="flex items-center gap-3 px-4 py-3
              hover:bg-gray-100 dark:hover:bg-dark-third
              {% if conv.id == conversation.id %}
                  bg-gray-100 dark:bg-dark-third
              {% endif %}">

        <!-- Avatar -->
        <img src="{{ conv.other.profile.picture.url }}"
             class="w-12 h-12 rounded-full object-cover"
             alt="{{ conv.other.username }}">

        <!-- Info -->
        <div class="flex-1 min-w-0">
            <p class="font-semibold text-sm dark:text-dark-txt truncate">
                {{ conv.other.username }}
            </p>

            {% if conv.last_message %}
            <p class="text-xs text-gray-500 truncate">
                {{ conv.last_message.body }}
            </p>
            {% endif %}
        </div>

        {% if conv.unread_count > 0 %}
        <span class="ml-auto bg-blue-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">
            {{ conv.unread_count }}
        </span>
        {% endif %}
    </a>

</div>
{% endfor %}


    </aside>


    <!-- CHAT AREA -->
    <main class="flex-1 flex flex-col">

        <!-- HEADER CHAT -->
        <div class="bg-white dark:bg-dark-second border-b dark:border-dark-third px-6 py-4 flex items-center gap-3">
            <img src="{{ other_user.profile.picture.url }}"
                 class="w-10 h-10 rounded-full object-cover" alt="mensajes">

            <h3 class="font-semibold dark:text-dark-txt">
                {{ other_user.username }}
            </h3>
        </div>

        <!-- MESSAGES -->
        <div class="flex-1 overflow-y-auto p-6 space-y-3">

            {% for message in conversation.messages.all %}
            <div class="flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %}">
                <div class="max-w-xs px-4 py-2 rounded-2xl text-sm
                    {% if message.sender == request.user %}
                        bg-blue-500 text-white rounded-br-none
                    {% else %}
                        bg-gray-200 dark:bg-dark-third dark:text-dark-txt rounded-bl-none
                    {% endif %}">
                    {{ message.body }}
                </div>
            </div>
            {% endfor %}

        </div>

        <!-- INPUT -->
        <form method="post"
              class="bg-white dark:bg-dark-second border-t dark:border-dark-third p-4 flex gap-2">
            {% csrf_token %}
            <input name="body"
                   class="flex-1 rounded-full px-4 py-2 border dark:bg-dark-third dark:border-dark-third dark:text-dark-txt"
                   placeholder="EscribÃ­ un mensajeâ€¦">
            <button class="px-5 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-full">
                Enviar
            </button>
        </form>

    </main>

</div>

{% endblock content %}